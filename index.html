<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recycling Plant Locator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f4f4; }
        #map { width: 100%; height: 400px; border-radius: 10px; margin-top: 20px; }
        .result-card { margin-top: 20px; padding: 15px; border-radius: 10px; background-color: white; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 class="text-center mb-4">Recycling Plant Locator</h2>
        <div class="input-group mb-3">
            <input type="text" id="zipCode" class="form-control" placeholder="Enter ZIP code">
            <button class="btn btn-success" onclick="findRecyclingPlants()">Search</button>
        </div>

        <div id="results"></div>
        <div id="map"></div>
    </div>

    <script>
        let map;
        let markers = [];

        function findRecyclingPlants() {
            let zip = document.getElementById("zipCode").value;
            if (!zip) {
                alert("Please enter a ZIP code.");
                return;
            }

            // Clear previous results and map markers
            clearPreviousResults();

            // Fetch the location for the entered zip code
            fetch(`https://nominatim.openstreetmap.org/search?postalcode=${zip}&format=json`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        alert("Invalid ZIP code. Try again.");
                        return;
                    }
                    let userLat = parseFloat(data[0].lat);
                    let userLon = parseFloat(data[0].lon);
                    searchRecyclingCenters(userLat, userLon);
                })
                .catch(error => console.error("Error fetching location:", error));
        }

        function clearPreviousResults() {
            // Clear the map and previous markers
            if (map) {
                map.remove();
            }
            markers = [];

            // Clear results on the page
            document.getElementById("results").innerHTML = '';
            document.getElementById("map").innerHTML = '';
        }

        function searchRecyclingCenters(userLat, userLon) {
            // Initialize Leaflet map
            map = L.map('map').setView([userLat, userLon], 12);

            // Use OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add marker for user's location
            L.marker([userLat, userLon]).addTo(map)
                .bindPopup("Your Location")
                .openPopup();

            // Overpass API query for all types of recycling plants in the area
            const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node["amenity"="recycling_bin"](around:5000,${userLat},${userLon});node["amenity"="waste_disposal"](around:5000,${userLat},${userLon});node["amenity"="recycling"](around:5000,${userLat},${userLon});out;`;

            fetch(overpassUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.elements.length === 0) {
                        alert("No recycling plants found nearby.");
                        return;
                    }

                    const sortedPlants = sortByDistance(userLat, userLon, data.elements);
                    displayResults(sortedPlants, userLat, userLon);
                })
                .catch(error => console.error("Error fetching recycling centers:", error));
        }

        function sortByDistance(userLat, userLon, centers) {
            // Calculate the distance for each plant and sort by proximity
            return centers.map(plant => {
                let lat = plant.lat;
                let lon = plant.lon;
                let distance = calculateDistance(userLat, userLon, lat, lon);
                let name = plant.tags.name || "Unnamed Recycling Plant"; // Get the name, fallback to default
                return { name: name, lat: lat, lon: lon, distance: distance };
            }).sort((a, b) => a.distance - b.distance);  // Sort by distance (nearest first)
        }

        function displayResults(plants, userLat, userLon) {
            let resultsDiv = document.getElementById("results");
            resultsDiv.innerHTML = "<h4>Nearby Recycling Plants (Sorted by Distance):</h4>";

            plants.forEach((plant, index) => {
                // Create a result card for each plant with its actual name
                let resultCard = document.createElement("div");
                resultCard.className = "result-card";
                resultCard.innerHTML = `
                    <h4>${index + 1}. ${plant.name}</h4>
                    <p><strong>Distance:</strong> ~${plant.distance.toFixed(2)} km</p>
                `;
                resultsDiv.appendChild(resultCard);

                // Add marker for each recycling plant
                L.marker([plant.lat, plant.lon]).addTo(map)
                    .bindPopup(`<strong>${plant.name}</strong><br>Distance: ~${plant.distance.toFixed(2)} km`)
                    .openPopup();
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
    </script>
</body>
</html>
